<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="https://unpkg.com/monaco-editor@0.51.0/min/vs/editor/editor.main.css">
    <style type="text/css">
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="container" style="width: 100%; height: 100%"></div>
    <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <script>
        var editor, origin, filePath, fileContent, fileType, source;

        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('container'), {
                value: '',
                language: '',
                theme: 'vs-dark',
                automaticLayout: true,
                "semanticHighlighting.enabled": true
            });

            document.addEventListener('keydown', async function (e) {
                if (e.ctrlKey && e.key.toLocaleLowerCase() == 's') {
                    e.preventDefault();
                    
                    console.log('Save file');

                    await window.parent.fs.writeFile(filePath, new Blob([editor.getValue()], fileType ? {
                        type: fileType
                    } : {})).then(() => {
                        console.log('File saved');
                    });
                }
            });

            window.onresize = function () {
                editor.layout();
            };
        });

        function getLanguage(extension) {
            switch (extension) {
                case 'js':
                    return 'javascript';
                case 'html':
                    return 'html';
                case 'css':
                    return 'css';
                case 'json':
                    return 'json';
                default:
                    return 'plaintext';
            }
        }

        document.addEventListener('init', (e) => {
            var data = e.detail;

            try {
                filePath = data.filePath;
                fileContent = data.fileContent;
                fileType = data.fileType;
                editor.setValue(data.fileContent);
                monaco.editor.setModelLanguage(editor.getModel(), getLanguage(filePath.split('.').pop().toLowerCase()));
            } catch (error) {
                console.error('Error loading file:', error);
                status = 'error';
            }

            let event = new CustomEvent('check', {
                detail: {
                    status: status
                }
            });
            window.parent.document.dispatchEvent(event);
        })

        /*
        window.addEventListener('message', (event) => {
            origin = event.origin;
            source = event.source;

            var message = JSON.parse(event.data);
            if (message.type == 'init') {
                var status = 'ok';
                try {
                    filePath = message.filePath;
                    fileContent = message.fileContent;
                    editor.setValue(message.fileContent);
                    monaco.editor.setModelLanguage(editor.getModel(), getLanguage(filePath.split('.').pop().toLowerCase()));
                } catch (error) {
                    console.error('Error loading file:', error);
                    status = 'error';
                }

                source.postMessage(JSON.stringify({
                    type: 'check',
                    status: status
                }), origin);
            }
        });
        */
    </script>
</body>

</html>